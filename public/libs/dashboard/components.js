var APPLICATION=APPLICATION||{};APPLICATION.Components=new function(){"use strict";var e=this;e.Global=new function(){var e=this;e.forDelete={},e.forSave={},e.RootURL="content/component/",e.requestOptions={headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")},error:function(e){var t=window.open("",":Error Message","menubar=no, location=no");t.document.write(e.responseText)}}},e.Helper=new function(){var t=this;t.initSortable=function(t,a){var n=!1;t.sortable({items:".item",handle:a,opacity:.8,stop:function(e){$(e.target).find(".item").each(function(e,t){$(t).attr("data-order",e+1).attr("changed","true")})},over:function(){n=!1},out:function(){n=!0},beforeStop:function(a,o){if(1==n){o.item.remove();o.item.attr("data-id");e.Global.forDelete[t.selector.substring(11)].push(o.item.attr("data-id"))}}})},t.initImagePreview=function(){var e=function(e){if(e.files&&e.files[0]){var t=new FileReader;t.onload=function(e){$("#modal_preview").attr("src",e.target.result)},t.readAsDataURL(e.files[0])}};$("#modal_image").change(function(){e(this)})},t.getURL=function(){return{getComponentsData:e.Global.RootURL+"get/all",update:e.Global.RootURL+"update/all","delete":e.Global.RootURL+"delete/all"}},t.modal=new function(){var e=this,a=$("#modal"),n=null,o=!1;this.open=function(e){n=e;for(var t=e.properties.length;t--;)"order"==e.properties[t]&&$("#modal_"+e.properties[t]).text(e.item.attr("data-order")).parent().removeClass("hidden"),"image"==e.properties[t]?$("#modal_preview").attr("src",e.item.find("img").attr("src")).parent().removeClass("hidden"):$("#modal_"+e.properties[t]).val(e.item.find("."+e.properties[t]).text()).parent().removeClass("hidden");a.modal()},this.save=function(e){e.item.attr("changed","true");for(var t=e.properties.length;t--;)"order"!=e.properties[t]&&("image"==e.properties[t]?e.item.find("img").attr("src",$("#modal_preview").attr("src")):e.item.find("."+e.properties[t]).text($("#modal_"+e.properties[t]).val()));o&&(e.target.append(e.item.removeClass("hidden cloneable").addClass("item").attr("data-id",Date.now())),e.target.parent().sortable("option","stop")({target:e.target.get(0)}))},this.init=function(t){t.target.on("click",".item",function(){e.open({item:$(this),properties:t.properties})})},this.initNewItem=function(t){t.target.on("click",".new-item",function(){o=!0,e.open({target:t.target.find(".innerContent"),item:t.item.clone(),properties:t.properties})})},t.initImagePreview(),a.find(".save-item").on("click",function(){a.modal("hide"),e.save(n),n=null}),a.find(".delete-item").on("click",function(){n.item.remove(),n=null,a.modal("hide")}),a.on("hidden.bs.modal",function(){a.find("form").get(0).reset(),a.find("img").attr("src",""),a.find(".form-group").addClass("hidden"),o=!1}),$("#modal_date").datetimepicker({format:"Y-m-d",timepicker:!1})},t.initStarFive=function(e){var t=null,a=e.find(".stars");a.each(function(e,t){for(var a=parseInt($(t).parent().attr("data-stars"))||1,e=0;e<5;e++)e<a?$(t).append('<span class="glyphicon glyphicon-star active"></span>'):$(t).append('<span class="glyphicon glyphicon-star"></span>')}),a.on("mouseenter",function(){t=$(this).clone(),$(this).on("mouseover",function(e){return e.target!=this&&($(e.target).prevAll().addClass("active"),$(e.target).addClass("active"),void $(e.target).nextAll().removeClass("active"))})}).on("mouseleave",function(){$(this).off("mouseover"),$(this).html(t.html())}).on("click",function(e){e.stopPropagation(),e.target!=this&&(t=$(this).clone(),$(this).parent().attr("data-stars",$(this).find(".active").length).attr("changed","true"))})}},e.loadComponents=new function(){e.Global.requestOptions.success=function(t){for(var a=Object.keys(t),n=a.length;n--;)e.initComponent(a[n],t[a[n]].data,t[a[n]].schema),e.Global.forDelete[a[n]]=[],e.Global.forSave[a[n]]={},e.Global.forSave[a[n]].componentData=[],e.Global.forSave[a[n]].requestData=t[a[n]].schema},e.Global.requestOptions.type="GET",$.ajax(e.Helper.getURL().getComponentsData,e.Global.requestOptions),window.onload=function(){$("#save-changes").on("click",e.saveComponents)}},e.initComponent=function(t,a,n){var o=$(".component_"+t),r=o.find(".cloneable"),i=o.find(".innerContent"),s=o.find(".sortableHandle");e.Helper.initSortable(o,s.length>0&&".sortableHandle"),o.get(0).hasAttribute("data-modal")&&(e.Helper.modal.init({target:i,properties:n}),e.Helper.modal.initNewItem({target:o,properties:n,item:r}));for(var l=a.length;l--;){for(var d=r.clone(),c=Object.keys(a[l]),p=c.length;p--;){var f=c[p];"id"==f||"order"==f||"stars"==f?d.attr("data-"+f,a[l][f]):"image"==f?d.find("img").attr("src",a[l][f]):d.find("."+f).text(a[l][f])}d.removeClass("hidden cloneable"),d.addClass("item"),i.prepend(d)}"Blockquote"==t&&(e.Helper.initStarFive(o),o.find(".panel-body").on("input",".name",function(e){$(e.delegateTarget).parent().prev().find(".name").text($(this).text())}))},e.saveComponents=function(){for(var t=Object.keys(e.Global.forSave),a=!1,n=t.length;n--;){var o=$("#"+t[n]+" [changed='true']"),r=e.Global.forSave[t[n]].requestData,i=e.Global.forSave[t[n]].componentData;o.each(function(e,t){for(var n={},o=r.length;o--;){var s=r[o];"id"==s||"order"==s||"stars"==s?n[s]=parseInt($(t).attr("data-"+s)):"image"==s?n[s]=$(t).find("img").attr("src"):n[s]=$(t).find("."+s).text()}i.push(n),a=i.length>0})}e.Global.requestOptions.success=function(a){$.notify("Successfully saved","success");for(var n=t.length;n--;)e.Global.forSave[t[n]].componentData=[];$("[changed=true]").attr("changed","false");for(var o=Object.keys(a),n=o.length;n--;)for(var r=o[n],i=a[r].length;i--;)$("#"+r+" [data-id='"+a[r][i].request_id+"']").attr("data-id",a[r][i].response_id)},e.Global.requestOptions.error=function(a){for(var n=t.length;n--;)e.Global.forSave[t[n]].componentData=[];var o=window.open("",":Error Message","menubar=no, location=no");o.document.write(a.responseText)},e.Global.requestOptions.data={forDelete:e.Global.forDelete,forSave:e.Global.forSave},e.Global.requestOptions.type="POST",a?$.ajax(e.Helper.getURL().update,e.Global.requestOptions):$.notify("Nothing changed","info"),$.ajax($("#componentsControl").attr("data-url"),{type:"POST",headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")},data:function(){var e=[];return $(".isActive").each(function(t,a){e.push({id:$(a).attr("data-id"),active:$(a).prop("checked")})}),{data:e}}()})}};